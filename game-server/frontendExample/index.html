<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Colyseus Message Handling</title>
    <script src="https://cdn.jsdelivr.net/npm/colyseus.js/dist/colyseus.min.js"></script>
  </head>
  <body>
    <h1>Colyseus Message Handling</h1>
    <form id="messageForm">
      <input
        type="text"
        id="messageInput"
        placeholder="Enter your message"
        required
      />
      <button type="submit">Send</button>
    </form>

    <ul id="messages"></ul>

    <form id="numberForm">
      <input
        type="number"
        id="numberInput"
        placeholder="Enter a number (0-9)"
        min="0"
        max="9"
        required
      />
      <button type="submit">take a seat</button>
      <button id="leaveSeat">leave seat</button>
    </form>
    <button id="ready">ready</button>
    <button id="unready">unready</button>
    <script>
      // Connect to the Colyseus server
      const client = new Colyseus.Client('ws://localhost:2567')
      let room
      let myId
      async function joinRoom() {
        try {
          room = await client.joinOrCreate('my_room')
          console.log('Joined room successfully!', room)
          myId = room.sessionId
          // Listen for messages from the server
          room.onMessage('message', (message) => {
            console.log('Received message from server:', message)

            // Ensure the message is an object and contains expected fields
            if (message && typeof message === 'object') {
              const messagesList = document.getElementById('messages')
              const newMessage = document.createElement('li')

              const playerName =
                myId === message.playerId
                  ? `${message.playerName}(You)`
                  : message.playerName
              const timestamp = new Date(message.timestamp).toLocaleTimeString()
              const content = message.message || ''

              // Format the message for display
              newMessage.textContent = `[${timestamp}] ${playerName}: ${content}`
              messagesList.appendChild(newMessage)
            } else {
              console.warn('Unexpected message format:', message)
            }
          })
        } catch (err) {
          console.error('Failed to join room:', err)
        }
      }

      joinRoom()

      // Handle form submission
      const messageForm = document.getElementById('messageForm')
      messageForm.addEventListener('submit', (event) => {
        event.preventDefault()
        const messageInput = document.getElementById('messageInput')
        const message = messageInput.value

        // Send message to the server
        if (room) {
          room.send('message', message)
          console.log('Message sent to server:', message)

          // Display sent message in the list

          messageInput.value = '' // Clear input field
        }
      })

      // Handle number form submission
      const numberForm = document.getElementById('numberForm')
      numberForm.addEventListener('submit', (event) => {
        event.preventDefault()
        const numberInput = document.getElementById('numberInput')
        const number = parseInt(numberInput.value, 10)

        if (room && !isNaN(number)) {
          room.send('joinGame', number)
          console.log('Number sent to server:', number)

          // Clear the input field
          numberInput.value = ''
        }
      })
      const leaveSeatButton = document.getElementById('leaveSeat')
      leaveSeatButton.addEventListener('click', () => {
        if (room) {
          room.send('leaveSeat')
        }
      })
      // Event handlers for new buttons
    </script>
  </body>
</html>
